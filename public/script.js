// === Szenzor adatainak friss√≠t√©se ===
async function fetchData() {
  try {
    const response = await fetch('https://api.thingspeak.com/channels/2875631/feeds.json?results=1');
    if (!response.ok) {
      throw new Error(`HTTP error! Status: ${response.status}`);
    }
    const data = await response.json();
    const lastEntry = data.feeds[0];

    const temp = parseFloat(lastEntry.field1);
    const humidity = parseFloat(lastEntry.field2);

    document.getElementById('temperature').innerText = temp + " ¬∞C";
    document.getElementById('humidity').innerText = humidity + " %";

    let overallStatus = "";
    let statusClass = "normal";

    if (temp > 30) {
      overallStatus += "üî• Meleg van! ";
      statusClass = "high";
    } else if (temp < 18) {
      overallStatus += "‚ùÑÔ∏è Hideg van! ";
      statusClass = "low";
    }

    if (humidity > 60) {
      overallStatus += "üí¶ Magas a p√°ratartalom! ";
      statusClass = "high";
    } else if (humidity < 30) {
      overallStatus += "üí® Sz√°raz a leveg≈ë! ";
      statusClass = "low";
    }

    if (overallStatus === "") {
      overallStatus = '<i class="fas fa-circle-check" style="color: lightgreen;"></i> Megfelel≈ë k√∂rnyezet';
      statusClass = "normal";
    }

    const statusEl = document.getElementById("overall-status");
    statusEl.innerHTML = overallStatus;
    statusEl.className = "status " + statusClass;
  } catch (error) {
    console.error("Error fetching data:", error);
    document.getElementById('temperature').innerText = "N/A";
    document.getElementById('humidity').innerText = "N/A";
    document.getElementById("overall-status").innerText = "H√°l√≥zati hiba. Ellen≈ërizze az internetkapcsolatot.";
    document.getElementById("overall-status").className = "status low";
  }
}
setInterval(fetchData, 5000);
fetchData();

// === "Tov√°bb" gombhoz tartoz√≥ toggleCharts f√ºggv√©ny ===
function toggleCharts() {
  const chartsDiv = document.getElementById("charts");
  const button = document.querySelector(".more-btn");

  if (chartsDiv.style.display === "none" || chartsDiv.style.display === "") {
    chartsDiv.style.display = "block";
    chartsDiv.style.opacity = "0";
    setTimeout(() => {
      chartsDiv.style.opacity = "1";
    }, 50);
    button.innerHTML = '<i class="fas fa-times"></i> Bez√°r';
  } else {
    chartsDiv.style.opacity = "0";
    setTimeout(() => {
      chartsDiv.style.display = "none";
    }, 300);
    button.innerHTML = '<i class="fas fa-chart-line"></i> Tov√°bb';
  }
}

// === Admin modal, login √©s panel kezel√©se ===
function openAdminModal() {
  document.getElementById('adminModal').style.display = 'block';
  renderModalContent();
}

function closeAdminModal() {
  document.getElementById('adminModal').style.display = 'none';
}

function renderModalContent() {
  const modalBody = document.getElementById('modal-body');
  if (sessionStorage.getItem('admin') === 'true') {
    modalBody.innerHTML = `
      <h2>Admin Panel</h2>
      <div class="smart-plug-toggle">
        <div id="wifiStatus" class="smart-plug-status off">Wifi kikapcsolva</div>
        <label class="switch">
          <input type="checkbox" id="smartPlugToggle" onchange="toggleSmartPlug(this.checked)">
          <span class="slider"></span>
        </label>
        <span id="smartPlugStatus">Ki</span>
      </div>

      <button onclick="logoutAdmin()" class="logout-btn">Kijelentkez√©s</button>
    `;
    fetchSmartPlugStatus();
  } else {
    modalBody.innerHTML = `
      <h2>Admin bejelentkez√©s</h2>
      <form id="modalLoginForm">
        <input type="text" id="modalUsername" placeholder="Felhaszn√°l√≥n√©v" required>
        <input type="password" id="modalPassword" placeholder="Jelsz√≥" required>
        <button type="submit">Bejelentkez√©s</button>
        <div class="error" id="modalError"></div>
      </form>
    `;
    document.getElementById('modalLoginForm').addEventListener('submit', function(e) {
      e.preventDefault();
      const username = document.getElementById('modalUsername').value;
      const password = document.getElementById('modalPassword').value;

      fetch('https://balintkiss-github-io.onrender.com/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify({ username, password })
          document.getElementById('modalError').textContent = data.message || 'Hiba t√∂rt√©nt a bejelentkez√©s sor√°n.';
        }
      })
      .catch(error => {
        console.error('Hiba a bejelentkez√©s sor√°n:', error);
        document.getElementById('modalError').textContent = 'Hiba t√∂rt√©nt a bejelentkez√©s sor√°n.';
      });
    });
  }
}

// === Smart plug toggle kezel√©s MongoDB-vel ===
function toggleSmartPlug(isOn) {
  const statusText = document.getElementById('smartPlugStatus');
  const wifiStatus = document.getElementById('wifiStatus');

  statusText.innerText = isOn ? "Be" : "Ki";
  wifiStatus.innerText = isOn ? "Wifi bekapcsolva" : "Wifi kikapcsolva";
  wifiStatus.className = 'smart-plug-status ' + (isOn ? 'on' : 'off');

  // Save state locally
  localStorage.setItem('smartPlugState', isOn ? 'on' : 'off');

  // Still attempt API call but don't rely on it
  try {
    fetch('https://balintkiss-github-io.onrender.com/api/smartplug', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'include',
      body: JSON.stringify({ isOn })
    })
    .then(response => response.json())
    .then(data => {
      console.log("Smart plug v√°lasz:", data);
    })
    .catch(error => console.error("Hiba a smart plug v√°lt√°sakor:", error));
  } catch (e) {
    console.log("API nem el√©rhet≈ë, de a helyi √°llapot mentve");
  }
}

function fetchSmartPlugStatus() {
  // V√°ltoz√≥ a szerver k√©r√©s nyomon k√∂vet√©s√©re
  let serverRequestSent = false;
  
  // Helyi √°llapot ellen≈ërz√©se
  const savedState = localStorage.getItem('smartPlugState');
  if (savedState) {
    const isOn = savedState === 'on';
    updatePlugUI(isOn);
  }

  // Szerverr≈ël lek√©r√©s
  try {
    serverRequestSent = true;
    fetch('https://balintkiss-github-io.onrender.com/api/smartplug', {
      credentials: 'include'
    })
    .then(response => {
      if (!response.ok) {
        throw new Error('Szerver hiba: ' + response.status);
      }
      return response.json();
    })
    .then(data => {
      // Csak akkor friss√≠ts√ºk az UI-t, ha k√ºl√∂nb√∂zik a helyi √°llapott√≥l
      const serverIsOn = data.isOn;
      const currentLocalState = localStorage.getItem('smartPlugState') === 'on';
      
      if (currentLocalState !== serverIsOn) {
        console.log("Szerver √°llapot elt√©r a helyit≈ël, friss√≠t√©s...");
        localStorage.setItem('smartPlugState', serverIsOn ? 'on' : 'off');
        updatePlugUI(serverIsOn);
      }
    })
    .catch(error => {
      console.error('Nem siker√ºlt lek√©rdezni a smart plug √°llapot√°t:', error);
    });
  } catch (e) {
    console.log("API nem el√©rhet≈ë, helyi √°llapot haszn√°lva");
  }
  
  // Ha 5 m√°sodpercen bel√ºl nem kapunk v√°laszt a szervert≈ël, 
  // maradjunk a helyi √°llapotn√°l
  setTimeout(() => {
    if (serverRequestSent) {
      console.log("Szerver v√°lasz id≈ët√∫ll√©p√©s - helyi √°llapot megtart√°sa");
    }
  }, 5000);
}

function logoutAdmin() {
  fetch('https://balintkiss-github-io.onrender.com/logout', {
    method: 'POST',
    credentials: 'include'
  })
  .then(response => response.json())
  .then(data => {
    sessionStorage.removeItem('admin');
    closeAdminModal();
  })
  .catch(error => console.error('Kijelentkez√©si hiba:', error));
}

window.onclick = function(event) {
  const modal = document.getElementById('adminModal');
  if (event.target === modal) {
    closeAdminModal();
  }
};

// === Cookie banner ===
function checkCookiePermission() {
  if (navigator.userAgent.includes('Chrome') && !localStorage.getItem('cookiesAccepted')) {
    document.getElementById('cookie-banner').style.display = 'block';
  }
}

function acceptCookies() {
  localStorage.setItem('cookiesAccepted', 'true');
  document.getElementById('cookie-banner').style.display = 'none';
  location.reload(); // √∫jrat√∂lt√©s, hogy a session is √∫jra pr√≥b√°lkozzon
}

window.onload = checkCookiePermission;
